pipeline {
    //RUN THIS PIPELINE ON THE REMOTE APPLICATION SERVER
    agent { label 'application-server' }

    tools {
        // Uses the NodeJS tool configured in Jenkins (must be configured on the agent, too)
        nodejs 'NodeJS_20' 
    }
    
    environment {
        APP_DIR = 'express-frontend'
        PM2_BIN = 'pm2' // Assuming PM2 is now in the PATH on the agent machine
    }

    stages {
        stage('Checkout Code') {
            steps {
                // Clones the entire single repository into the agent workspace
                git branch: 'main', credentialsId: 'YOUR_GIT_CREDENTIAL_ID', url: 'https://github.com/pradeepdhanave/CICD-Jenkins.git' 
            }
        }

        stage('Install Dependencies') {
            steps {
                // Execute npm install inside the application subdirectory (${APP_DIR})
                sh "npm --prefix ${APP_DIR} install"
            }
        }

        stage('Deploy & Restart') {
            steps {
                // Restart the application using the PM2 binary.
                // The 'start' command uses 'server.js' and sets the CWD to the app directory.
                sh "${PM2_BIN} restart express-app || ${PM2_BIN} start server.js --name express-app --interpreter node --cwd ./${APP_DIR}"
                echo 'Express app deployment complete and process restarted.'
            }
        }
    }
}