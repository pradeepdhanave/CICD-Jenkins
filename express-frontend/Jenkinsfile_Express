pipeline {
    agent any

    tools {
        // Uses the NodeJS tool configured in Jenkins
        nodejs 'NodeJS_20' 
    }
    
    environment {
        // Path to the application directory relative to the Jenkins workspace root
        APP_DIR = 'express-frontend'
    }

    stages {
        stage('Checkout Code') {
            steps {
                // Clones the entire single repository
                git branch: 'main', credentialsId: 'YOUR_GIT_CREDENTIAL_ID', url: 'https://github.com/pradeepdhanave/CICD-Jenkins.git' 
            }
        }

        stage('Install Dependencies') {
            steps {
                // Execute npm install inside the application subdirectory (${APP_DIR})
                sh "npm --prefix ${APP_DIR} install"
            }
        }

        stage('Deploy & Restart') {
            steps {
                // Restart the application using the correct PM2 command
                // The CWD is set to the app directory to ensure 'node_modules' is found.
                sh "pm2 restart express-app || pm2 start ./express-frontend/server.js --name express-app --interpreter node --cwd ./express-frontend"
                echo 'Express app deployment complete and process restarted.'
            }
        }
    }
}